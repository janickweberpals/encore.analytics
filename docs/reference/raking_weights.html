<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Estimate raking weights for a mimids or wimids object — raking_weights • encore.analytics</title><!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png"><link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png"><link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png"><link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png"><link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png"><link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png"><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Estimate raking weights for a mimids or wimids object — raking_weights"><meta name="description" content="Function estimates raking weights for multiple imputed and matched (mimids)
or weighted (wimids) datasets. That is to match the distributions of
certain variables in the imputed and matched/weighted datasets to a distribution of
a target population (e.g., clinical trial population)."><meta property="og:description" content="Function estimates raking weights for multiple imputed and matched (mimids)
or weighted (wimids) datasets. That is to match the distributions of
certain variables in the imputed and matched/weighted datasets to a distribution of
a target population (e.g., clinical trial population)."><meta property="og:image" content="https://janickweberpals.github.io/encore.analytics/logo.png"></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">encore.analytics</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.2.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="active nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles"><li><a class="external-link dropdown-item" href="https://janickweberpals.github.io/imputation-ps-workflows/chapters/background.html" target="_blank">Background</a></li>
    <li><a class="external-link dropdown-item" href="https://janickweberpals.github.io/imputation-ps-workflows/chapters/syvcox_coxph.html" target="_blank">Multiple Imputation and Propensity Score Matching in a Survival Analysis Context</a></li>
    <li><a class="external-link dropdown-item" href="https://janickweberpals.github.io/imputation-ps-workflows/chapters/raking_weights.html" target="_blank">Incorporating Raking Weights</a></li>
    <li><a class="external-link dropdown-item" href="https://janickweberpals.github.io/imputation-ps-workflows/chapters/km_pooling.html" target="_blank">Pooling of Kaplan-Meier Curves after Multiple Imputation and Propensity Score Weighting</a></li>
    <li><a class="external-link dropdown-item" href="https://janickweberpals.github.io/imputation-ps-workflows/chapters/agreement_metrics.html" target="_blank">Computation of Agreement Metrics</a></li>
  </ul></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-reports" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Reports</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-reports"><li><a class="dropdown-item" href="../coverage.html" target="_blank">Coverage report</a></li>
  </ul></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json"></form></li>
      </ul></div>


  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Estimate raking weights for a mimids or wimids object</h1>
      <small class="dont-index">Source: <a href="https://github.com/janickweberpals/encore.analytics/blob/HEAD/R/raking_weights.R" class="external-link"><code>R/raking_weights.R</code></a></small>
      <div class="d-none name"><code>raking_weights.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>Function estimates raking weights for multiple imputed and matched (<code>mimids</code>)
or weighted (<code>wimids</code>) datasets. That is to match the distributions of
certain variables in the imputed and matched/weighted datasets to a distribution of
a target population (e.g., clinical trial population).</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">raking_weights</span><span class="op">(</span><span class="va">x</span>, targets <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>


<dl><dt id="arg-x">x<a class="anchor" aria-label="anchor" href="#arg-x"></a></dt>
<dd><p>imputed and matched (mimids) or weighted (wimids) object</p></dd>


<dt id="arg-targets">targets<a class="anchor" aria-label="anchor" href="#arg-targets"></a></dt>
<dd><p>list of all target values for the raking procedure</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    <p>list of data frames with updated raking weights (<code>raking_weights</code>)</p>
    </div>
    <div class="section level2">
    <h2 id="details">Details<a class="anchor" aria-label="anchor" href="#details"></a></h2>
    <p>The function requires an object of class mimids or wimids (<code>x</code>), which is the output
of a workflow that requires imputing multiple (m) datasets using mice or amelia
and matching or weighting each imputed dataset via the MatchThem package
(see examples).</p>
<p>The function additionally requires a list of target distributions (<code>targets</code>) for each variable
that is considered for the raking procedure. The list should contain named vectors with the target
distributions for each variable and the names of the vectors should match the variable names in the imputed datasets.</p>
<p>In brief, the raking procedure iteratively adjusts the weights to make the weighted sample percentages match the target
population percentages for the selected variables.It does this by multiplying the current weight for each case by a
factor based on the ratio of the target population proportion to the weighted sample proportion for a given category.
This adjustment is performed sequentially for each category of each selected variable. Because adjusting for one
variable can disrupt the match for previous variables, the process is repeated through all selected variables in cycles.
This iterative process minimizes the Kullback-Leibler (KL) divergence and continues until the weighted sample proportions
match the target population proportions for all categories ("full convergence"), or until no further change occurs.</p>
<p>The function follows the following logic:</p><ol><li><p>Extract the ith imputed dataset from the mimids or wimids object</p></li>
<li><p>Create a temporary case/patient ID</p></li>
<li><p>Apply the <code><a href="https://rdrr.io/pkg/anesrake/man/anesrake.html" class="external-link">anesrake</a></code> function to the ith imputed dataset</p></li>
<li><p>Create a temporary dataframe with the case ID and replace the initial weights with the updated raking weights</p></li>
<li><p>Merge the temporary dataframe with the ith imputed dataset</p></li>
<li><p>Drop the temporary case ID</p></li>
<li><p>Return the ith imputed dataset with the raking weights</p></li>
</ol><p>The function returns a list of data frames with the updated raking weights. These
updated raking weights overwrite in each data frame the existing <code>weights</code> column.
This column can then be used in a downstream analysis (e.g., Kaplan-Meier, Cox proportional hazards regression).</p>
    </div>
    <div class="section level2">
    <h2 id="see-also">See also<a class="anchor" aria-label="anchor" href="#see-also"></a></h2>
    <div class="dont-index"><p><code><a href="https://rdrr.io/pkg/anesrake/man/anesrake.html" class="external-link">anesrake</a></code> <code><a href="https://rdrr.io/pkg/MatchThem/man/matchthem.html" class="external-link">matchthem</a></code> <code><a href="https://rdrr.io/pkg/MatchThem/man/weightthem.html" class="external-link">weightthem</a></code></p></div>
    </div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span></span></span>
<span class="r-in"><span> <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://janickweberpals.github.io/encore.analytics/">encore.analytics</a></span><span class="op">)</span></span></span>
<span class="r-in"><span> <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/amices/mice" class="external-link">mice</a></span><span class="op">)</span></span></span>
<span class="r-in"><span> <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span></span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> </span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> Attaching package: ‘dplyr’</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> The following objects are masked from ‘package:stats’:</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> </span>
<span class="r-msg co"><span class="r-pr">#&gt;</span>     filter, lag</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> The following objects are masked from ‘package:base’:</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> </span>
<span class="r-msg co"><span class="r-pr">#&gt;</span>     intersect, setdiff, setequal, union</span>
<span class="r-in"><span> <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/FarhadPishgar/MatchThem" class="external-link">MatchThem</a></span><span class="op">)</span></span></span>
<span class="r-in"><span> <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/therneau/survival" class="external-link">survival</a></span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span> <span class="co"># simulate a cohort with 1,000 patients with 20% missing data</span></span></span>
<span class="r-in"><span> <span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="simulate_data.html">simulate_data</a></span><span class="op">(</span></span></span>
<span class="r-in"><span>   n <span class="op">=</span> <span class="fl">500</span>,</span></span>
<span class="r-in"><span>   imposeNA <span class="op">=</span> <span class="cn">TRUE</span>,</span></span>
<span class="r-in"><span>   propNA <span class="op">=</span> <span class="fl">0.2</span></span></span>
<span class="r-in"><span>   <span class="op">)</span> <span class="op">|&gt;</span></span></span>
<span class="r-in"><span>   <span class="co"># anesrake works best with factor variables</span></span></span>
<span class="r-in"><span>   <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>c_smoking_history <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">c_smoking_history</span> <span class="op">==</span> <span class="cn">TRUE</span>, <span class="st">"Current/former"</span>, <span class="st">"Never"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span> <span class="co"># impute the data (create mids object)</span></span></span>
<span class="r-in"><span> <span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">42</span><span class="op">)</span></span></span>
<span class="r-in"><span> <span class="va">mids</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://amices.org/mice/reference/mice.html" class="external-link">mice</a></span><span class="op">(</span><span class="va">data</span>, m <span class="op">=</span> <span class="fl">5</span>, print <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> <span class="warning">Warning: </span>Number of logged events: 801</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span> <span class="co"># define covariates for propensity score model</span></span></span>
<span class="r-in"><span> <span class="va">covariates</span> <span class="op">&lt;-</span> <span class="va">data</span> <span class="op">|&gt;</span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">starts_with</a></span><span class="op">(</span><span class="st">"c_"</span><span class="op">)</span>, <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">starts_with</a></span><span class="op">(</span><span class="st">"dem_"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span></span>
<span class="r-in"><span>   <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span> <span class="co"># define propensity score model</span></span></span>
<span class="r-in"><span> <span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/formula.html" class="external-link">as.formula</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"treat ~"</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">covariates</span>, collapse <span class="op">=</span> <span class="st">" + "</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span> <span class="co"># match patients within each imputed dataset</span></span></span>
<span class="r-in"><span> <span class="va">mimids</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/MatchThem/man/matchthem.html" class="external-link">matchthem</a></span><span class="op">(</span></span></span>
<span class="r-in"><span>   formula <span class="op">=</span> <span class="va">fit</span>,</span></span>
<span class="r-in"><span>   datasets <span class="op">=</span> <span class="va">mids</span>,</span></span>
<span class="r-in"><span>   approach <span class="op">=</span> <span class="st">'within'</span>,</span></span>
<span class="r-in"><span>   method <span class="op">=</span> <span class="st">'nearest'</span></span></span>
<span class="r-in"><span>   <span class="op">)</span></span></span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> </span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> Matching Observations  | dataset: #1</span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> <span class="warning">Warning: </span>Fewer control units than treated units; not all treated units will get</span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> a match.</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span>  #2</span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> <span class="warning">Warning: </span>Fewer control units than treated units; not all treated units will get</span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> a match.</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span>  #3</span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> <span class="warning">Warning: </span>Fewer control units than treated units; not all treated units will get</span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> a match.</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span>  #4</span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> <span class="warning">Warning: </span>Fewer control units than treated units; not all treated units will get</span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> a match.</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span>  #5</span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> <span class="warning">Warning: </span>Fewer control units than treated units; not all treated units will get</span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> a match.</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> </span>
<span class="r-in"><span></span></span>
<span class="r-in"><span> <span class="va">smoker_target</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">.35</span>, <span class="fl">.65</span><span class="op">)</span></span></span>
<span class="r-in"><span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">smoker_target</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Current/former"</span>, <span class="st">"Never"</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span> <span class="co"># summarize target distributions in a named list vector</span></span></span>
<span class="r-in"><span> <span class="va">targets</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">smoker_target</span><span class="op">)</span></span></span>
<span class="r-in"><span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">targets</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"c_smoking_history"</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span> <span class="co"># estimate raking weights</span></span></span>
<span class="r-in"><span> <span class="va">mirwds</span> <span class="op">&lt;-</span> <span class="fu">raking_weights</span><span class="op">(</span></span></span>
<span class="r-in"><span>   x <span class="op">=</span> <span class="va">mimids</span>,</span></span>
<span class="r-in"><span>   targets <span class="op">=</span> <span class="va">targets</span></span></span>
<span class="r-in"><span>   <span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1] "Raking converged in 5 iterations"</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1] "Raking converged in 7 iterations"</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1] "Raking converged in 3 iterations"</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1] "Raking converged in 6 iterations"</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1] "Raking converged in 7 iterations"</span>
<span class="r-in"><span></span></span>
</code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Janick Weberpals.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer></div>





  </body></html>

