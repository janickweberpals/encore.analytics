% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/cox_pooling.R
\name{cox_pooling}
\alias{cox_pooling}
\title{Manually fit and pool Cox proportional hazards model results from multiple imputed datasets}
\usage{
cox_pooling(
  x,
  surv_formula = stats::as.formula(survival::Surv(fu_itt_months, death_itt) ~ treat)
)
}
\arguments{
\item{x}{A list of imputed datasets with weights or raking weights (e.g., from \code{\link[encore.analytics]{raking_weights}})
and optional cluster information (for matched datasets).}

\item{surv_formula}{A formula for the Cox proportional hazards model (default is \code{Surv(fu_itt_months, death_itt) ~ treat}).}
}
\value{
A data frame containing the pooled results, including hazard ratios, confidence intervals, and p-values.
}
\description{
This function manually fits and pools results from Cox proportional hazards models using
a list of imputed datasets. It leverages the \code{mice::as.mira} and \code{mice::pool} functions to
ensure proper pooling of results across multiple imputations using Rubin's rules.
}
\details{
The function requires a list of imputed data frames with weights and optional cluster (matching) information,
as well as a formula for the Cox proportional hazards model. The data frames must include a column named
\code{weights}, and optionally a column named \code{subclass} (for matched datasets to indicate cluster membership).

This function is particularly useful when working with imputed datasets that are not in the form of
\code{mimids} or \code{wimids} objects, such as when intermediate steps like raking weights
(via \code{raking_weights}) are applied. It provides a flexible way to fit and pool Cox models
while ensuring compatibility with Rubin's rules for multiple imputation.

The function follows these steps:
\enumerate{
\item Fit a Cox proportional hazards model to each imputed dataset. If a \code{subclass} column is present,
it is used as a cluster variable for matched pairs.
\item Convert the list of fitted models into a \code{mira} object using \code{mice::as.mira}.
\item Pool the results using \code{mice::pool}, which applies Rubin's rules for combining estimates
and variances across imputations.
\item Format the pooled results, including exponentiating the hazard ratios and calculating confidence intervals.
}
}
\examples{
library(encore.analytics)
library(mice)
library(MatchThem)

# Simulate a cohort with 500 patients and 20\% missing data
data <- simulate_data(
  n = 500,
  imposeNA = TRUE,
  propNA = 0.2
)

# Impute the data
set.seed(42)
mids <- mice(data, m = 5, print = FALSE)

# Fit a propensity score model
fit <- as.formula(treat ~ dem_age_index_cont + dem_sex_cont + c_smoking_history)

# Weight patients within each imputed dataset
wimids <- weightthem(
  formula = fit,
  datasets = mids,
  approach = "within",
  method = "glm",
  estimand = "ATO"
)

# Create a list of imputed and weighted datasets
wimids_list <- MatchThem::complete(wimids, action = "all", all = FALSE, include = FALSE)

# Define a survival model formula
cox_fit <- as.formula(survival::Surv(fu_itt_months, death_itt) ~ treat)

# Fit and pool Cox proportional hazards model results
cox_pooling(wimids_list, surv_formula = cox_fit)
}
\seealso{
\code{\link[survival]{coxph}}, \code{\link[mice]{pool}}, \code{\link[mice]{as.mira}},
\code{\link[MatchThem]{matchthem}}, \code{\link[MatchThem]{weightthem}}
}
