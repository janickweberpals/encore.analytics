<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Pooled Kaplan-Meier estimate and survival curve — km_pooling • encore.analytics</title><!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png"><link rel="icon" type="”image/svg+xml”" href="../favicon.svg"><link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png"><link rel="icon" sizes="any" href="../favicon.ico"><link rel="manifest" href="../site.webmanifest"><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Pooled Kaplan-Meier estimate and survival curve — km_pooling"><meta name="description" content="Computes pooled median survival Kaplan-Meier estimates using Rubin's rule
and outputs corresponding Kaplan-Meier curve across imputed and
matched/weighted datasets"><meta property="og:description" content="Computes pooled median survival Kaplan-Meier estimates using Rubin's rule
and outputs corresponding Kaplan-Meier curve across imputed and
matched/weighted datasets"><meta property="og:image" content="https://janickweberpals.github.io/encore.analytics/logo.png"></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">encore.analytics</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="active nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-reports" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Reports</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-reports"><li><a class="dropdown-item" href="../coverage.html">Coverage report</a></li>
  </ul></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json"></form></li>
      </ul></div>


  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Pooled Kaplan-Meier estimate and survival curve</h1>
      <small class="dont-index">Source: <a href="https://github.com/janickweberpals/encore.analytics/blob/main/R/km_pooling.R" class="external-link"><code>R/km_pooling.R</code></a></small>
      <div class="d-none name"><code>km_pooling.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>Computes pooled median survival Kaplan-Meier estimates using Rubin's rule
and outputs corresponding Kaplan-Meier curve across imputed and
matched/weighted datasets</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">km_pooling</span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  surv_formula <span class="op">=</span> <span class="fu">stats</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/stats/formula.html" class="external-link">as.formula</a></span><span class="op">(</span><span class="fu">survival</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">fu_itt_months</span>, <span class="va">death_itt</span><span class="op">)</span> <span class="op">~</span> <span class="va">treat</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>


<dl><dt id="arg-x">x<a class="anchor" aria-label="anchor" href="#arg-x"></a></dt>
<dd><p>imputed and matched (mimids) or weighted (wimids) object</p></dd>


<dt id="arg-surv-formula">surv_formula<a class="anchor" aria-label="anchor" href="#arg-surv-formula"></a></dt>
<dd><p>specification of survival model formula to be fitted</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    <p>list with pooled median survival estimate and pooled Kaplan-Meier curve
<code>km_median_survival</code>:</p><ul><li><p>strata = stratum</p></li>
<li><p>t_median = median survival time</p></li>
<li><p>t_lower = lower 95% CI of median survival time</p></li>
<li><p>t_upper = upper 95% CI of median survival time</p></li>
</ul><p><code>km_survival_table</code>:</p><ul><li><p>strata = stratum</p></li>
<li><p>time = observed time point</p></li>
<li><p>m = number of imputed datasets</p></li>
<li><p>qbar = pooled univariate estimate of the complementary log-log transformed survival probabilities, see formula (3.1.2) Rubin (1987)</p></li>
<li><p>t = total variance of the pooled univariate estimate of the complementary log-log transformed survival probabilities, formula (3.1.5) Rubin (1987)</p></li>
<li><p>se = total standard error of the pooled estimate (derived as sqrt(t))</p></li>
<li><p>surv = back-transformed pooled survival probability</p></li>
<li><p>lower = Wald-type lower 95% confidence interval of back-transformed pooled survival probability</p></li>
<li><p>upper = Wald-type upper 95% confidence interval of back-transformed pooled survival probability</p></li>
</ul><p><code>km_plot</code>: ggplot2 object with Kaplan-Meier curve</p>
    </div>
    <div class="section level2">
    <h2 id="details">Details<a class="anchor" aria-label="anchor" href="#details"></a></h2>
    <p>The function requires an object of class mimids or wimids (<code>x</code>), which is the output
of a workflow that requires imputing multiple (m) datasets using mice or amelia
and matching or weighting each imputed dataset via the MatchThem package
(see examples).</p>
<p>The function fits the pre-specified survfit model (<code>surv_formula</code>, <code><a href="https://rdrr.io/pkg/survival/man/survfit.html" class="external-link">survfit</a></code> package)
to compute survival probabilities at each individual time point according to the Kaplan-Meier method.
For matched and weighted datasets, weights, cluster membership (matching only) and robust
variance estimates are considered in the <code><a href="https://rdrr.io/pkg/survival/man/survfit.html" class="external-link">survfit</a></code> call by default.</p>
<p>Since survival probabilities typically don't follow normal distributions,
these need to be transformed to approximate normality first before pooling
across imputed datasets and time points. To that end, survival probabilities are first
transformed using a complementary log-log transformation (<code>log(-log(1-pr(surv)))</code>)
as recommended by multiple sources (Marshall, Billingham, and Bryan (2009)).</p>
<p>To pool the transformed estimates across imputed datasets and time points, the pool.scalar
function is used to apply Rubin's rule to combine pooled estimates (qbar) according to
formula (3.1.2) Rubin (1987) and to compute the corresponding total variance (t) of the pooled
estimate according to formula (3.1.5) Rubin (1987).</p>
<p>The pooled survival probabilities are then back-transformed via <code>1-exp(-exp(qbar))</code>
for pooled survival probability estimates and <code>1-exp(-exp(qbar +/- 1.96*sqrt(t)))</code>
for lower and upper 95% confidence intervals. As the formula indicates, the pooled standard
error is computed as the square root of the total variance. The vertically stacked table
with transformed and backtransformed estimates is returned with the
<code>km_survival_table</code> table.</p>
<p>Finally, the median survival time is extracted from the <code>km_survival_table</code> table
by determining the time the survival probability drops below .5 for the first time.
For this a sub-function of Terry M. Therneau's <code><a href="https://rdrr.io/pkg/survival/man/print.survfit.html" class="external-link">print.survfit</a></code> function
is used. Therneau also considers some edge cases/nuisances (x = time, y = surv):</p><ul><li><p>Nuisance 1: if one of the y's is exactly .5, we want the mean of the corresponding x and the first x for which y&lt;.5. We need to use the equivalent of all.equal to check for a .5 however: survfit(Surv(1:100)~1) gives a value of .5 + 1.1e-16 due to roundoff error.</p></li>
<li><p>Nuisance 2: there may by an NA in the y's</p></li>
<li><p>Nuisance 3: if no y's are &lt;=.5, then we should return NA</p></li>
<li><p>Nuisance 4: the obs (or many) after the .5 may be censored, giving a stretch of values = .5 +- epsilon</p></li>
</ul><p>The function follows the following logic:</p><ol><li><p>Fit Kaplan-Meier survival function to each imputed and matched/weighted dataset</p></li>
<li><p>Transform survival probabilities using complementary log-log transformation</p></li>
<li><p>Pool transformed survival probabilities and compute total variance using Rubin's rule</p></li>
<li><p>Back-transform pooled survival probabilities and compute 95% confidence intervals</p></li>
<li><p>Extract median survival time and corresponding 95% confidence intervals</p></li>
<li><p>Plot Kaplan-Meier curve with pooled survival probabilities and confidence intervals</p></li>
</ol><p>More references:</p><ul><li><p>https://stefvanbuuren.name/fimd/sec-pooling.html</p></li>
<li><p>https://link.springer.com/article/10.1007/s10198-008-0129-y</p></li>
<li><p>https://bmcmedresmethodol.biomedcentral.com/articles/10.1186/s12874-015-0048-4</p></li>
</ul></div>
    <div class="section level2">
    <h2 id="see-also">See also<a class="anchor" aria-label="anchor" href="#see-also"></a></h2>
    <div class="dont-index"><p><code><a href="https://rdrr.io/pkg/survival/man/survfit.html" class="external-link">survfit</a></code> <code><a href="https://amices.org/mice/reference/pool.scalar.html" class="external-link">pool.scalar</a></code> <code><a href="https://rdrr.io/pkg/MatchThem/man/matchthem.html" class="external-link">matchthem</a></code> <code><a href="https://rdrr.io/pkg/MatchThem/man/weightthem.html" class="external-link">weightthem</a></code></p></div>
    </div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span> <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://janickweberpals.github.io/encore.analytics/">encore.analytics</a></span><span class="op">)</span></span></span>
<span class="r-in"><span> <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/amices/mice" class="external-link">mice</a></span><span class="op">)</span></span></span>
<span class="r-in"><span> <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/FarhadPishgar/MatchThem" class="external-link">MatchThem</a></span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span> <span class="co"># simulate a cohort with 1,000 patients with 20% missing data</span></span></span>
<span class="r-in"><span> <span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="simulate_data.html">simulate_data</a></span><span class="op">(</span></span></span>
<span class="r-in"><span>   n <span class="op">=</span> <span class="fl">500</span>,</span></span>
<span class="r-in"><span>   imposeNA <span class="op">=</span> <span class="cn">TRUE</span>,</span></span>
<span class="r-in"><span>   propNA <span class="op">=</span> <span class="fl">0.2</span></span></span>
<span class="r-in"><span>   <span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span> <span class="co"># impute the data</span></span></span>
<span class="r-in"><span> <span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">42</span><span class="op">)</span></span></span>
<span class="r-in"><span> <span class="va">mids</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://amices.org/mice/reference/mice.html" class="external-link">mice</a></span><span class="op">(</span><span class="va">data</span>, m <span class="op">=</span> <span class="fl">5</span>, print <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> <span class="warning">Warning: </span>Number of logged events: 801</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span> <span class="co"># fit a propensity score model</span></span></span>
<span class="r-in"><span> <span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/formula.html" class="external-link">as.formula</a></span><span class="op">(</span><span class="va">treat</span> <span class="op">~</span> <span class="va">dem_age_index_cont</span> <span class="op">+</span> <span class="va">dem_sex_cont</span> <span class="op">+</span> <span class="va">c_smoking_history</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span> <span class="co"># weight (or alternatively match) patients within each imputed dataset</span></span></span>
<span class="r-in"><span> <span class="va">wimids</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/MatchThem/man/weightthem.html" class="external-link">weightthem</a></span><span class="op">(</span></span></span>
<span class="r-in"><span>   formula <span class="op">=</span> <span class="va">fit</span>,</span></span>
<span class="r-in"><span>   datasets <span class="op">=</span> <span class="va">mids</span>,</span></span>
<span class="r-in"><span>   approach <span class="op">=</span> <span class="st">"within"</span>,</span></span>
<span class="r-in"><span>   method <span class="op">=</span> <span class="st">"glm"</span>,</span></span>
<span class="r-in"><span>   estimand <span class="op">=</span> <span class="st">"ATO"</span></span></span>
<span class="r-in"><span>   <span class="op">)</span></span></span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> Estimating weights     | dataset: #1</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span>  #2</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span>  #3</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span>  #4</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span>  #5</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> </span>
<span class="r-in"><span></span></span>
<span class="r-in"><span> <span class="co"># fit a survival model</span></span></span>
<span class="r-in"><span> <span class="va">km_fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/formula.html" class="external-link">as.formula</a></span><span class="op">(</span><span class="fu">survival</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">fu_itt_months</span>, <span class="va">death_itt</span><span class="op">)</span> <span class="op">~</span> <span class="va">treat</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span> <span class="co"># estimate and pool median survival times and Kaplan-Meier curve</span></span></span>
<span class="r-in"><span> <span class="va">km_out</span> <span class="op">&lt;-</span> <span class="fu">km_pooling</span><span class="op">(</span></span></span>
<span class="r-in"><span>   x <span class="op">=</span> <span class="va">wimids</span>,</span></span>
<span class="r-in"><span>   surv_formula <span class="op">=</span> <span class="va">km_fit</span></span></span>
<span class="r-in"><span>   <span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span> <span class="co"># median survival time</span></span></span>
<span class="r-in"><span> <span class="va">km_out</span><span class="op">$</span><span class="va">km_median_survival</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #949494;"># A tibble: 2 × 4</span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   strata  t_median t_lower t_upper</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #BCBCBC;">1</span> treat=0     16.7    14.0    19.6</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #BCBCBC;">2</span> treat=1     20.5    17.7    24.3</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span> <span class="co"># KM curve</span></span></span>
<span class="r-in"><span> <span class="va">km_out</span><span class="op">$</span><span class="va">km_plot</span></span></span>
<span class="r-plt img"><img src="km_pooling-1.png" alt="" width="700" height="433"></span>
<span class="r-in"><span></span></span>
</code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Janick Weberpals.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.2.</p>
</div>

    </footer></div>





  </body></html>

